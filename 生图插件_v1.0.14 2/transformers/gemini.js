(function(){"use strict";function se(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var B={exports:{}},u={};var z;function ce(){if(z)return u;z=1;var t=Symbol.for("react.element"),n=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),a=Symbol.for("react.profiler"),m=Symbol.for("react.provider"),v=Symbol.for("react.context"),x=Symbol.for("react.forward_ref"),j=Symbol.for("react.suspense"),D=Symbol.for("react.memo"),$=Symbol.for("react.lazy"),R=Symbol.iterator;function k(e){return e===null||typeof e!="object"?null:(e=R&&e[R]||e["@@iterator"],typeof e=="function"?e:null)}var b={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},S=Object.assign,I={};function h(e,r,s){this.props=e,this.context=r,this.refs=I,this.updater=s||b}h.prototype.isReactComponent={},h.prototype.setState=function(e,r){if(typeof e!="object"&&typeof e!="function"&&e!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,r,"setState")},h.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")};function E(){}E.prototype=h.prototype;function T(e,r,s){this.props=e,this.context=r,this.refs=I,this.updater=s||b}var A=T.prototype=new E;A.constructor=T,S(A,h.prototype),A.isPureReactComponent=!0;var te=Array.isArray,re=Object.prototype.hasOwnProperty,V={current:null},ne={key:!0,ref:!0,__self:!0,__source:!0};function oe(e,r,s){var l,c={},d=null,y=null;if(r!=null)for(l in r.ref!==void 0&&(y=r.ref),r.key!==void 0&&(d=""+r.key),r)re.call(r,l)&&!ne.hasOwnProperty(l)&&(c[l]=r[l]);var p=arguments.length-2;if(p===1)c.children=s;else if(1<p){for(var f=Array(p),_=0;_<p;_++)f[_]=arguments[_+2];c.children=f}if(e&&e.defaultProps)for(l in p=e.defaultProps,p)c[l]===void 0&&(c[l]=p[l]);return{$$typeof:t,type:e,key:d,ref:y,props:c,_owner:V.current}}function Oe(e,r){return{$$typeof:t,type:e.type,key:r,ref:e.ref,props:e.props,_owner:e._owner}}function H(e){return typeof e=="object"&&e!==null&&e.$$typeof===t}function Pe(e){var r={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,function(s){return r[s]})}var ie=/\/+/g;function J(e,r){return typeof e=="object"&&e!==null&&e.key!=null?Pe(""+e.key):r.toString(36)}function M(e,r,s,l,c){var d=typeof e;(d==="undefined"||d==="boolean")&&(e=null);var y=!1;if(e===null)y=!0;else switch(d){case"string":case"number":y=!0;break;case"object":switch(e.$$typeof){case t:case n:y=!0}}if(y)return y=e,c=c(y),e=l===""?"."+J(y,0):l,te(c)?(s="",e!=null&&(s=e.replace(ie,"$&/")+"/"),M(c,r,s,"",function(_){return _})):c!=null&&(H(c)&&(c=Oe(c,s+(!c.key||y&&y.key===c.key?"":(""+c.key).replace(ie,"$&/")+"/")+e)),r.push(c)),1;if(y=0,l=l===""?".":l+":",te(e))for(var p=0;p<e.length;p++){d=e[p];var f=l+J(d,p);y+=M(d,r,s,f,c)}else if(f=k(e),typeof f=="function")for(e=f.call(e),p=0;!(d=e.next()).done;)d=d.value,f=l+J(d,p++),y+=M(d,r,s,f,c);else if(d==="object")throw r=String(e),Error("Objects are not valid as a React child (found: "+(r==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":r)+"). If you meant to render a collection of children, use an array instead.");return y}function N(e,r,s){if(e==null)return e;var l=[],c=0;return M(e,l,"","",function(d){return r.call(s,d,c++)}),l}function Te(e){if(e._status===-1){var r=e._result;r=r(),r.then(function(s){(e._status===0||e._status===-1)&&(e._status=1,e._result=s)},function(s){(e._status===0||e._status===-1)&&(e._status=2,e._result=s)}),e._status===-1&&(e._status=0,e._result=r)}if(e._status===1)return e._result.default;throw e._result}var g={current:null},F={transition:null},qe={ReactCurrentDispatcher:g,ReactCurrentBatchConfig:F,ReactCurrentOwner:V};function ue(){throw Error("act(...) is not supported in production builds of React.")}return u.Children={map:N,forEach:function(e,r,s){N(e,function(){r.apply(this,arguments)},s)},count:function(e){var r=0;return N(e,function(){r++}),r},toArray:function(e){return N(e,function(r){return r})||[]},only:function(e){if(!H(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},u.Component=h,u.Fragment=i,u.Profiler=a,u.PureComponent=T,u.StrictMode=o,u.Suspense=j,u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=qe,u.act=ue,u.cloneElement=function(e,r,s){if(e==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var l=S({},e.props),c=e.key,d=e.ref,y=e._owner;if(r!=null){if(r.ref!==void 0&&(d=r.ref,y=V.current),r.key!==void 0&&(c=""+r.key),e.type&&e.type.defaultProps)var p=e.type.defaultProps;for(f in r)re.call(r,f)&&!ne.hasOwnProperty(f)&&(l[f]=r[f]===void 0&&p!==void 0?p[f]:r[f])}var f=arguments.length-2;if(f===1)l.children=s;else if(1<f){p=Array(f);for(var _=0;_<f;_++)p[_]=arguments[_+2];l.children=p}return{$$typeof:t,type:e.type,key:c,ref:d,props:l,_owner:y}},u.createContext=function(e){return e={$$typeof:v,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},e.Provider={$$typeof:m,_context:e},e.Consumer=e},u.createElement=oe,u.createFactory=function(e){var r=oe.bind(null,e);return r.type=e,r},u.createRef=function(){return{current:null}},u.forwardRef=function(e){return{$$typeof:x,render:e}},u.isValidElement=H,u.lazy=function(e){return{$$typeof:$,_payload:{_status:-1,_result:e},_init:Te}},u.memo=function(e,r){return{$$typeof:D,type:e,compare:r===void 0?null:r}},u.startTransition=function(e){var r=F.transition;F.transition={};try{e()}finally{F.transition=r}},u.unstable_act=ue,u.useCallback=function(e,r){return g.current.useCallback(e,r)},u.useContext=function(e){return g.current.useContext(e)},u.useDebugValue=function(){},u.useDeferredValue=function(e){return g.current.useDeferredValue(e)},u.useEffect=function(e,r){return g.current.useEffect(e,r)},u.useId=function(){return g.current.useId()},u.useImperativeHandle=function(e,r,s){return g.current.useImperativeHandle(e,r,s)},u.useInsertionEffect=function(e,r){return g.current.useInsertionEffect(e,r)},u.useLayoutEffect=function(e,r){return g.current.useLayoutEffect(e,r)},u.useMemo=function(e,r){return g.current.useMemo(e,r)},u.useReducer=function(e,r,s){return g.current.useReducer(e,r,s)},u.useRef=function(e){return g.current.useRef(e)},u.useState=function(e){return g.current.useState(e)},u.useSyncExternalStore=function(e,r,s){return g.current.useSyncExternalStore(e,r,s)},u.useTransition=function(){return g.current.useTransition()},u.version="18.3.1",u}var G;function le(){return G||(G=1,B.exports=ce()),B.exports}var ae=le();const fe=se(ae);function de(t){return typeof t=="string"?t:t instanceof URL?t.href:t instanceof Request?t.url:String(t??"")}function Q(t){return new Promise(n=>setTimeout(n,t*1e3))}async function pe(t){let n;const i=t.headers.get("Content-Type")||"";try{if(i.includes("application/json"))n=await t.json();else if(i.includes("text/")){let o=await t.text();o=o.replace(/^for\s*\(\s*;;\s*\);/,"").trim();try{n=JSON.parse(o)}catch{n=o}}else if(i.includes("application/octet-stream")||i.includes("blob"))n=await t.blob();else if(i.includes("form-data"))n=await t.formData();else{let o=await t.text();try{n=JSON.parse(o)}catch{n=o}}}catch{}return n}function L(t){let n=t;const i=new Set;for(;n;)Object.getOwnPropertyNames(n).forEach(o=>i.add(o)),n=Object.getPrototypeOf(n);return Array.from(i)}function ye(t){return{all:t=t||new Map,on:function(n,i){var o=t.get(n);o?o.push(i):t.set(n,[i])},off:function(n,i){var o=t.get(n);o&&(i?o.splice(o.indexOf(i)>>>0,1):t.set(n,[]))},emit:function(n,i){var o=t.get(n);o&&o.slice().map(function(a){a(i)}),(o=t.get("*"))&&o.slice().map(function(a){a(n,i)})}}}function me(t,n){const i=o=>{n(o),window.emitter.off(t,i)};window.emitter.on(t,i)}const he=ye();window.emitter=he;const K="ucs-standalone-app",we="ucs-chat-landing",ge="ucs-nav-panel",W="ucs-search-bar",ve=".tools-button-container",Se="ucs-file-picker-menu",w={getApp(){return document.querySelector(K)?.shadowRoot},getConversation(){return w.getApp()?.querySelector("ucs-results")?.shadowRoot?.querySelector("ucs-conversation")},getLanding(){return w.getApp()?.querySelector(we)?.shadowRoot},getNavPanel(){return w.getApp()?.querySelector(ge)},getSearchBar(){const t=w.getLanding()?.querySelector(W)||w.getApp()?.querySelector(W);if(t)return t;throw new Error("找不到工具栏")},getToolsContainer(){return w.getSearchBar()?.shadowRoot?.querySelector(ve)},getToolsButton(){return w.getToolsContainer()?.querySelector("md-text-button")},getToolsMenu(){const t=w.getToolsContainer()?.querySelector("md-menu");if(t)return t;throw new Error("找不到工具菜单")},getFilePickerMenu(){const t=w.getSearchBar()?.shadowRoot?.querySelector(Se);if(t)return t;throw new Error("找不到选择文件菜单")},startNewChat(){w.getNavPanel()?.shadowRoot?.querySelector(".chat-button")?.click?.()},openToolsMenu(){const t=w.getToolsButton();if(t?.click)t.click();else throw new Error("无法切换生成类型")},getTypeItem(t){if(t==="video"&&P)return P;if(t==="image"&&O)return O;const n=w.getSearchBar(),i=L(n);for(const o of i){const a=n[o];if(Array.isArray(a)){if(!O){const m=a.find(v=>v.id==="generate_image");m&&(O=m)}if(!P){const m=a.find(v=>v.id==="generate_video");m&&(P=m)}if(t==="video"&&P)return P;if(t==="image"&&O)return O}}throw new Error("找不到类型对象")},updateConversation(t){const n=document.querySelector(K),i=w.getConversation();if(!(!n||!i||!("update"in i)||typeof i.update!="function")){if(n!==X){X=n;const o=this.findSessionObj(n);o&&(U=o)}U&&(U._value=t,i.update(),console.log("update ",t))}},findSessionObj(t){const n=L(t);for(const i of n)if(t[i]?.configId&&"namespace"in t[i]&&"agentService"in t[i]){const o=t[i],a=L(o);for(const m of a){const v=o[m]?._value;if(typeof v=="string"&&/^\d+$/.test(v))return o[m]}}}};let X,U,O,P,q=null,C=[];function Y(){q!=null&&(clearInterval(q),q=null)}function _e(){if(!C.length){Y();return}const t=C.shift();t?(C.push(t),w.updateConversation(t)):Y()}function Re(t){C.push(t),q==null&&(q=setInterval(_e,5e3))}function Z(t){return(t||"").match(/sessions\/(\d+)/)?.[1]}window.currentProcess={row:null,prompt:"",folder:"",filename:""};function be(){const t=window.fetch;window.fetch=async(n,i)=>{const o=de(n),a=o.includes("widgetAddContextFile"),m=o.includes("widgetCreateSession")&&window.currentProcess.row!=null,v=o.includes("widgetListSessionFileMetadata"),x=a||m||v;let j;if(x)try{typeof i?.body=="string"&&(j=JSON.parse(i.body))}catch(R){console.error("解析出错：",R)}const D={...window.currentProcess},$=await t(n,i);if(x)try{const R=$.clone(),k=await pe(R);if(k){if(a)k.addContextFileResponse.fileId?window.emitter.emit("onUploadImageFinish"):window.emitter.emit("onUploadImageFinish","上传文件出错："+JSON.stringify(k));else if(m){const b=j?.configId,S=Z(k.session?.name);b&&S&&(Re(S),window.emitter.emit("onSubmitSuccess",{...D,id:S}))}else if(v){const b=k.listSessionFileMetadataResponse?.fileMetadata,S=Z(j?.listSessionFileMetadataRequest?.name);if(Array.isArray(b)&&b.length&&S){const I=[];for(const h of b)if(h.fileOriginType==="AI_GENERATED"){if(h.mimeType?.includes("image")){const E=h.downloadUri;E&&I.push({url:E,thumbnail:E})}else if(h.mimeType?.includes("video")){const E=h.downloadUri;let T="";if(h.views){const A=Object.keys(h.views)[0];T=h.views[A].uri}I.push({url:E,thumbnail:T})}}I.length&&(C.includes(S)&&(C=C.filter(h=>h!==S)),window.emitter.emit("onReceiveData",{[S]:I}))}}}}catch(R){console.error(R)}return $}}const{getSearchBar:ee,getToolsMenu:Ee,openToolsMenu:Ce,getTypeItem:ke,getFilePickerMenu:Ie}=w;window.require=t=>{if(t==="react")return fe},window.setPrompt=t=>{const n=ee();n&&"value"in n&&(n.value=t)},window.generate=window.generateVideo=()=>{const t=ee();if(t&&"submit"in t&&typeof t.submit=="function")t.submit();else throw new Error("找不到提交按钮")},window.setCreateType=async t=>{const n=Ee().querySelectorAll("md-menu-item");if(n.length){Ce();const i=ke(t);await Q(2);for(const o of n){const a=o.textContent;if(a.includes(i.label)&&a.includes(i.icon)){const m=o.shadowRoot?.querySelector("md-item");if(m&&"click"in m&&typeof m.click=="function"){m.click(),await Q(2);return}}}}throw new Error("无法切换生成类型")},window.uploadImage=async t=>{const n=Ie();if(n){const i=new Promise(o=>{me("onUploadImageFinish",a=>{o(a)})});return n.dispatchEvent(new CustomEvent("gen-file-uploaded",{bubbles:!0,composed:!0,detail:{files:t}})),i}throw new Error("找不到上传文件菜单")},be()})();
