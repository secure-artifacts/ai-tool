var U=Object.defineProperty;var P=(e,t,r)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var f=(e,t,r)=>P(e,typeof t!="symbol"?t+"":t,r);import{e as E,P as _,a as A}from"./const-CyB7ld5s.js";var S=(e=>(e.WHISK="whisk",e.META_AI="meta-ai",e.SORA="sora",e.HAILUO="hailuo",e.GROK="grok",e.DREAMINA="dreamina",e.GEMINI="gemini",e.FLOW="flow",e.PLAYGROUND="playground",e.LMARENA="lmarena",e.HEDRA="hedra",e.OPAL="opal",e))(S||{});const h=Object.values(S);function d(e){return Object.fromEntries(typeof e=="function"?h.map(t=>[t,e(t)]):h.map(t=>[t,e]))}const L={type:"object",properties:d({type:"array",default:[],items:{type:"any"}}),required:h,default:d([])},F={type:"object",properties:d({type:"array",default:[],items:{type:"any"}}),required:h,default:d([])},R={type:"object",properties:d({type:"object",properties:{generate:{type:"object",properties:{times:{type:"number",default:1},interval:{type:"number",default:30},shouldDownload:{type:"boolean",default:!0},folderType:{type:"string",default:"不创建文件夹"}},required:["times","interval","shouldDownload","folderType"],default:{times:1,interval:30,shouldDownload:!0,folderType:"不创建文件夹"}},submit:{type:"object",properties:{history:{type:"boolean",default:!0},register:{type:"boolean",default:!1},submitter:{type:"string",default:""},webAppUrl:{type:"string",default:""},sheet:{type:"string",default:""}},required:["history","register","submitter","webAppUrl","sheet"],default:{histroy:!0,register:!1,submitter:"",webAppUrl:"",sheet:""}},window:{type:"object",properties:{x:{type:"number",default:0},y:{type:"number",default:0},width:{type:"number",default:0},height:{type:"number",default:0},adjustable:{type:"boolean",default:!1}},required:["x","y","width","height","adjustable"]}},required:["generate","submit","window"]}),required:h,default:d({generate:{times:1,interval:30,shouldDownload:!0,folderType:"不创建文件夹"},submit:{history:!0,register:!1,submitter:"",webAppUrl:"",sheet:""},window:{x:0,y:0,width:0,height:0,adjustable:!1}})},$={type:"object",properties:d({type:"object",default:{}}),required:h,default:d({})},w={promptData:F,settings:R,history:L,taskRecord:$};function H(e,t){(async()=>{let r=0,a=await chrome.declarativeNetRequest.getDynamicRules(),o=a.map(i=>i.id);const n=[...e,"https://sora-cdn.oaistatic.com/*","https://*.oaistatic.com/*"],s=e.map((i,c)=>(r=c+1,{id:r,priority:1,action:{type:"modifyHeaders",responseHeaders:[{header:"Content-Security-Policy",operation:"remove"},{header:"Content-Security-Policy-Report-Only",operation:"remove"}]},condition:{regexFilter:i,resourceTypes:["main_frame","xmlhttprequest"]}}));n.forEach(i=>{const c=i.replace(/\*/g,".*").replace(/\./g,"\\.").replace(/\//g,"\\/");s.push({id:++r,priority:100,action:{type:"modifyHeaders",requestHeaders:[{header:"If-None-Match",operation:"remove"},{header:"If-Modified-Since",operation:"remove"},{header:"Cache-Control",operation:"set",value:"no-cache, no-store, must-revalidate"},{header:"Pragma",operation:"set",value:"no-cache"}]},condition:{regexFilter:c,resourceTypes:["script","stylesheet","main_frame","sub_frame"]}}),s.push({id:++r,priority:100,action:{type:"modifyHeaders",responseHeaders:[{header:"Cache-Control",operation:"set",value:"no-cache, no-store, must-revalidate, max-age=0"},{header:"Pragma",operation:"set",value:"no-cache"},{header:"Expires",operation:"set",value:"0"},{header:"ETag",operation:"remove"},{header:"Last-Modified",operation:"remove"},{header:"Age",operation:"remove"},{header:"Cf-Cache-Status",operation:"remove"}]},condition:{regexFilter:c,resourceTypes:["script","stylesheet","main_frame","sub_frame"]}})}),await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:o,addRules:s}),await chrome.declarativeNetRequest.getDynamicRules()})()}function W(e){let t="",r="";if(e.startsWith("data:")){const n=e.split(",");t=n[1],r=n[0].split(":")[1].split(";")[0]}else t=e;let a=Uint8Array.from(atob(t),function(n){return n.charCodeAt(0)});return new Blob([a],{type:r||"image/jpeg"})}function M(e){return new Promise(t=>setTimeout(t,e*1e3))}function q(e){return/^(blob:|https?:\/\/)/.test(e)}function G(){const e=navigator.userAgent;return/Edg\//.test(e)?"Edge":/OPR\//.test(e)||/Opera/.test(e)?"Opera":/Chrome\//.test(e)&&!/Edg\//.test(e)&&!/OPR\//.test(e)?"Chrome":/Firefox\//.test(e)?"Firefox":/Safari\//.test(e)&&!/Chrome\//.test(e)&&!/Edg\//.test(e)&&!/OPR\//.test(e)?"Safari":/MSIE |Trident\//.test(e)?"IE":"Other"}async function K(e){var t;if(!e)return"";try{let r;if(!q(e))r=W(e);else{const s=await fetch(e);if(!s.ok)throw new Error("无法从链接获取图片");r=await s.blob()}const a=new FormData;return a.append("imagedata",r),a.append("access_token","VuiU5hFnJfdTk9OxQp9mlKvZBUujK-bPxpwPyOxIqXk"),(t=await(await fetch("https://upload.gyazo.com/api/v2/upload",{body:a,method:"POST"})).json())==null?void 0:t.url}catch(r){throw new Error("上传图片发生错误: "+r.message)}}async function J(e,t){var r;try{const a=((r=(await B("settings"))[e])==null?void 0:r.submit)||{history:!0,register:!1,submitter:"",webAppUrl:"",sheet:""},o=await K(t.imageUrl),n=new Date().toLocaleString(),s=`=IMAGE("${o}")`,i={time:n,submitter:a.submitter||"",pageTitle:t.pageTitle||"",pageUrl:t.pageUrl||"",imageUrl:o,imageFormula:s,prompt:t.prompt};return a.history&&await Q(e,{...i}),a.register&&await z([Object.values(i)],a),{error:""}}catch(a){return console.error("提交失败",a),{error:a.message}}}const V=3;async function z(e,t){const{webAppUrl:r,sheet:a}=t;if(!r)throw new Error("未设置 Web App 链接");if(!a)throw new Error("未设置分页名称");let n="data="+encodeURIComponent(JSON.stringify({action:"appendRows",sheetData:a,rows:e})),s=null,i=null,c="",l="";for(let u=0;u<V;u++){if(u){const b=Math.pow(3,u);await M(b)}i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:n}),c=await i.text();try{s=JSON.parse(c)}catch{}if(!i.ok||!s||!s.ok)l=s&&s.error||c||"写入失败";else{l="";break}}if(l)throw new Error(l);return s}async function Q(e,t){await v("history",r=>{let a=r[e]||[];return a.unshift(t),r[e]=a.length>200?a.slice(0,200):a,r})}const O=(e="")=>e.length?e[0].toUpperCase()+e.slice(1):"";function X(){const e={};return Object.keys(w).forEach(t=>{const r=t,a=`get${O(r)}`,o=`set${O(r)}`;e[a]=async n=>{const s=await B(t);return s[n]?s[n]:w[t].default[n]},e[o]=async(n,s)=>{await v(t,i=>(i[n]=s,i))}}),e}async function Y(e,t){!q(e)&&!e.startsWith("data:image")&&(e=`data:image/jpeg;base64,${e}`);try{return await chrome.downloads.download({url:e,filename:t,conflictAction:"uniquify",saveAs:!1}),""}catch(r){return console.error("下载文件出现错误：",r),r.message}}let Z=class{constructor(t,r){f(this,"listeners",{});f(this,"tabs",[]);f(this,"slug");f(this,"isDebugger");f(this,"callbackMap",new Map);this.slug=t,this.isDebugger=!!r,this.bindMessage(),this.bindEvent()}on(t,r){if(this.listeners[t])throw new Error(`event listener ${String(t)} already exist!`);return this.listeners[t]=r,()=>{delete this.listeners[t]}}async send(t,...r){this.isDebugger&&console.log("发送消息",{action:t,payload:r,tabs:this.tabs});for(let a of this.tabs)try{const o=await chrome.tabs.get(a);o&&o.id?chrome.tabs.sendMessage(o.id,{from:this.slug,payload:{action:t,payload:r}}):this.deleteTabById(a)}catch(o){console.log(o),this.deleteTabById(a)}}async sendWithCallback(t,r,...a){const o=T();this.callbackMap.set(o,r),this.isDebugger&&console.log("发送消息",{action:t,payload:a,tabs:this.tabs});for(let n of this.tabs)try{const s=await chrome.tabs.get(n);s&&s.id?chrome.tabs.sendMessage(s.id,{from:this.slug,payload:{action:t,payload:a},callbackId:o}):this.deleteTabById(n)}catch(s){console.log(s),this.deleteTabById(n)}}async sendByTabId(t,r,...a){this.isDebugger&&console.log("发送消息（指定 tabId）",{tabId:t,action:r,payload:a});const o=T();return new Promise((n,s)=>{this.callbackMap.set(o,function(i){n(i)}),chrome.tabs.get(t).then(i=>{i&&i.id?chrome.tabs.sendMessage(i.id,{from:this.slug,payload:{action:r,payload:a},callbackId:o}):this.deleteTabById(t)}).catch(i=>{console.log(i),this.deleteTabById(t)})})}bindMessage(){chrome.runtime.onMessageExternal.addListener((t,r,a)=>{var o,n,s;if((o=r==null?void 0:r.tab)!=null&&o.id){if(this.isDebugger&&console.log("收到消息",{request:t,sender:r}),t.action==="__connect")return this.tabs.includes(r.tab.id)||this.tabs.push(r.tab.id),a();if(t.action==="__disconnect")return this.deleteTabById(r.tab.id),a();if(t.action==="__callback"){const{callbackId:i,result:c,errorMessage:l,status:u}=t.payload;return u==="error"?console.error(l):this.callbackMap.has(i)&&((n=this.callbackMap.get(i))==null||n(c,r)),a()}if(this.listeners[t.action])return(s=r==null?void 0:r.tab)!=null&&s.id?(this.tabs.includes(r.tab.id)||this.tabs.push(r.tab.id),this.listeners[t.action].bind({request:t,sender:r})(...t.payload).then(i=>{this.isDebugger&&console.log("send to callback from background",{request:t,sender:r,res:i}),a({status:"success",result:i})}).catch(i=>{console.error(i),a({status:"error",errorMessage:i.toString()})}),!0):a()}})}bindEvent(){chrome.tabs.onRemoved.addListener(t=>{this.deleteTabById(t)})}deleteTabById(t){if(this.tabs.includes(t)){const r=this.tabs.indexOf(t);this.tabs.splice(r,1)}}};function T(){return new Date().getTime().toString()+Math.random().toString(36).substring(2,15)}function D(e,t){Object.keys(e).map(r=>t(e[r],r,e))}function y(e,t){function r(n,s){switch(n.type){case"object":return a(n,s);case"array":return o(n,s);default:return s!==void 0?s:n.default!==void 0?n.default:void 0}}function a(n,s){const i={},c=n.properties??{};return D(c,(l,u)=>{if(n.required.includes(u)||s!==void 0&&s[u]!==void 0){let b=s!==void 0?s[u]:void 0;!l.properties&&l.default&&l.type==="object"&&l.additionalProperties&&(b=l.default),i[u]=r(l,b)}}),s&&D(s,(l,u)=>{i[u]===void 0&&l!==void 0&&(i[u]=l)}),i}function o(n,s){if(s===void 0)return n.default?n.default:void 0;const i=[];for(let c=0;c<s.length;c++)i.push(r(n.items,s[c]));return i}return r(t,e)}const j=".auto-fill-local-version";function N(e){const t=Object.keys(e);chrome.runtime.onInstalled.addListener(a=>{(a.reason==="install"||a.reason==="update")&&r()});async function r(){let a=(await chrome.storage.local.get(j))[j];const o=chrome.runtime.getManifest().version;if(o!==a){const n=await chrome.storage.local.get(t),s=t.reduce((i,c)=>{let l=n[c]||{};return l=y(l,e[c]),i[c]=l,i},{[j]:o});await chrome.storage.local.set(s)}}}function ee(e,t){async function r(s,i){let c;return await navigator.locks.request(m(s),{mode:"shared"},async()=>{c=(await k(s))[s]}),(c===void 0||i!=null&&i.autoFillDefault)&&(c=y(c,e[s])),c}async function a(s,i,c){await navigator.locks.request(m(s),{mode:"exclusive"},async()=>{let l=(await k(s))[s];(l===void 0||c!=null&&c.autoFillDefault)&&(l=y(l,e[s]));const u=await i(l);await chrome.storage.local.set({[s]:u})})}async function o(s,i){await navigator.locks.request(m(s),{mode:"exclusive"},async()=>{let c=i||{};i||(c=y(c,e[s])),await chrome.storage.local.set({[s]:c})})}async function n(s){return await navigator.locks.request(m(s),{mode:"exclusive"},async()=>{await chrome.storage.local.remove([s])}),Promise.resolve()}return{updateBucket:a,setBucket:o,getBucket:r,deleteBucket:n}}function m(e){return`storage.local.${e}`}function k(e){return new Promise(t=>{chrome.storage.local.get(e,r=>{t(r)})})}const p=new Z(E,!0),{updateBucket:v,getBucket:B}=ee(w);function te(){const e=X();Object.keys(e).forEach(t=>{p.on(t,e[t])}),p.on("addTaskRecord",async(t,r)=>{await v("taskRecord",a=>(a[t]||(a[t]={}),Object.assign(a[t],r),a))}),p.on("updateSettings",async(t,r)=>{await v("settings",a=>(a[t]||(a[t]=R.default[t]),Object.assign(a[t],r),a))}),p.on("download",async(t,r,a)=>{if(G()==="Edge")try{return await re(),await chrome.runtime.sendMessage({target:"offscreen",type:"download",data:{url:t,filename:r.split("/").pop()}})}catch(o){return o.message}else return await Y(t,r)}),p.on("submit",async(t,r)=>{const a=new Promise(o=>{x.push({resolve:o,platform:t,payload:r})});return C(),a})}const x=[];let I=!1;async function C(){if(!x.length||I)return;const e=x.shift();if(!e)return;I=!0;const t=await J(e.platform,e.payload);e.resolve(t),await M(3),I=!1,C()}let g;async function re(e="/src/scopes/offscreen/index.html"){await chrome.offscreen.hasDocument()||(g?await g:(g=chrome.offscreen.createDocument({url:e,reasons:["BLOBS"],justification:"reason for needing the document"}),await g,g=null),await M(2))}function se(e,t){if(e==="<all_urls>")return/^(https?|file):\/\//.test(t);let r;try{r=new URL(t)}catch{return!1}const a=e.match(/^([^:]+):\/\/([^\/]+)(\/.*)?$/);if(!a)return!1;const[,o,n,s="/*"]=a;if(o==="*"){if(r.protocol!=="http:"&&r.protocol!=="https:")return!1}else if(r.protocol!==`${o}:`)return!1;return!!function(i,c){if(i==="*")return!0;if(i.startsWith("*.")){const l=i.slice(2);return c===l||c.endsWith("."+l)}return i===c}(n,r.hostname)&&!!function(i,c){const l=i.replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");return new RegExp(`^${l}$`,"i").test(c)}(s,r.pathname)}function ae(e){const{hostMatch:t,extensionId:r,isDev:a=!1}=e;chrome.tabs.onUpdated.addListener(async(o,n,s)=>{s&&s.url&&s&&s.url&&n&&n.status==="loading"&&t.some(i=>se(i,s.url))&&chrome.scripting.executeScript({injectImmediately:!0,world:"MAIN",target:{tabId:o,allFrames:!0},func:i=>{window[i.slug]=i},args:[{id:chrome.runtime.id,slug:r,isDev:a}]})})}ae({hostMatch:A,extensionId:E,isDev:!1});N(w);te();H(A);chrome.scripting.unregisterContentScripts().then(()=>{Object.entries(_).forEach(([e,t])=>{chrome.scripting.registerContentScripts([{id:`inject-${e}-proxy`,js:["transformers/common.js",`transformers/${e}.js`],matches:t,runAt:"document_start",world:"MAIN"}])}),chrome.scripting.registerContentScripts([{id:"inject-index-module",js:["externals.js","injects/index.js"],css:["injects/index.css"],matches:A,runAt:"document_end",world:"MAIN"}])});
