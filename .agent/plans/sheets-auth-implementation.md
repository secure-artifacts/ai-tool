# Google Sheets 认证方案实施计划

## 🎯 目标

实现三种认证模式，让用户根据需求选择：

| 模式 | 权限 | 适用场景 | 用户操作 |
|------|------|----------|----------|
| **API Key** | 只读 | 普通用户（默认） | 无需操作 |
| **Service Account** | 读+写 | 高级用户 | 上传自己的密钥 JSON |
| **OAuth 测试模式** | 读+写 | 受邀用户 | 需管理员添加邮箱 |

---

## 📋 需要写入权限的功能清单

### SheetMind 数据分析模块
| 功能 | 需要写入? | 说明 |
|------|----------|------|
| 读取/加载表格 | ❌ 不需要 | API Key 即可 |
| 数据分析/图表 | ❌ 不需要 | 本地处理 |
| 收藏功能 | ❌ 不需要 | 存储在 Firestore |
| 透视表查看 | ❌ 不需要 | 本地处理 |
| **同步版本到表格** | ✅ 需要 | 创建新分页并写入 |
| **更新文件状态** | ✅ 需要 | 写回原表格 |

### 专业文案查重工具
| 功能 | 需要写入? | 说明 |
|------|----------|------|
| 读取文案库 | ❌ 不需要 | API Key 即可 |
| 查重/搜索 | ❌ 不需要 | 本地处理 |
| **入库（添加文案）** | ✅ 需要 | 追加行到表格 |
| **创建分类** | ✅ 需要 | 创建新工作表 |
| **重命名/删除分类** | ✅ 需要 | 操作工作表 |

---

## 📝 用户提示文案

### 认证模式选择界面
```
📖 只读模式（API Key） - 默认
   适合：查看和分析公开表格
   无需额外操作

📝 读写模式 - Service Account
   适合：需要写入表格的高级用户
   需要：上传您自己的 Service Account 密钥
   [查看创建说明]

🧪 读写模式 - OAuth 测试
   适合：受邀测试用户
   需要：联系管理员添加您的邮箱
```

### 需要写入权限时的提示
```
⚠️ 此功能需要写入权限

当前为只读模式，如需使用以下功能，请配置写入权限：
• 同步版本到 Google Sheets
• 更新文件状态
• 入库/创建分类

[配置写入权限] [暂不需要]
```

---

## 🔧 实施步骤

### 阶段 1：创建统一认证服务 (sheetsAuthService.ts) ✅ 已完成
- [x] 定义认证模式类型
- [x] API Key 模式（只读）
- [x] Service Account 模式（读写）
- [x] Custom OAuth 模式（读写）
- [x] Built-in OAuth 测试模式（读写，需白名单）
- [x] 统一的 getAuthHeaders() 方法

### 阶段 2：Service Account 功能 ✅ 已完成
- [x] 密钥上传组件
- [x] 密钥验证（检查必要字段）
- [x] 本地存储（localStorage）
- [x] JWT 签名生成 Token
- [x] 创建使用说明文档

### 阶段 3：UI 更新 ✅ 已完成
- [x] 在 LoginModal 添加认证模式选择入口
- [x] SheetsAuthConfig 组件完整 UI
- [x] 需要写入权限时显示提示

### 阶段 4：OAuth 测试模式 ⏳ 待完成
- [ ] 恢复 Sheets scope
- [ ] 添加测试用户邮箱白名单
- [ ] 非白名单用户显示提示

### 阶段 5：文档 ✅ 已完成
- [x] Service Account 创建说明
- [x] 权限需求说明
- [x] 常见问题解答

---

## 📄 Service Account 创建说明（文档内容）

### 步骤 1：创建 Google Cloud 项目
1. 访问 https://console.cloud.google.com/
2. 点击顶部项目选择器 → "新建项目"
3. 输入项目名称（如 "我的表格工具"）
4. 点击"创建"

### 步骤 2：启用 Google Sheets API
1. 在左侧菜单选择 "API 和服务" → "库"
2. 搜索 "Google Sheets API"
3. 点击进入并点击 "启用"

### 步骤 3：创建 Service Account
1. 左侧菜单选择 "API 和服务" → "凭据"
2. 点击 "创建凭据" → "服务账号"
3. 输入服务账号名称（如 "sheets-writer"）
4. 点击 "创建并继续" → "完成"

### 步骤 4：生成密钥
1. 在凭据页面，点击刚创建的服务账号
2. 切换到 "密钥" 标签页
3. 点击 "添加密钥" → "创建新密钥"
4. 选择 "JSON" 格式 → "创建"
5. JSON 文件会自动下载，妥善保管

### 步骤 5：共享表格给 Service Account
1. 打开要操作的 Google Sheets
2. 点击右上角 "共享"
3. 输入 Service Account 邮箱（在密钥 JSON 的 client_email 字段）
4. 选择 "编辑者" 权限
5. 点击 "发送"

### 步骤 6：导入密钥到应用
1. 在应用中选择 "Service Account 模式"
2. 点击 "上传密钥"
3. 选择下载的 JSON 文件
4. 完成！

---

## ⏱️ 预计时间

| 阶段 | 时间 |
|------|------|
| 阶段 1：认证服务 | 1 小时 |
| 阶段 2：Service Account | 1.5 小时 |
| 阶段 3：UI 更新 | 1 小时 |
| 阶段 4：OAuth 测试 | 30 分钟 |
| 阶段 5：文档 | 30 分钟 |
| **总计** | **约 4.5 小时** |

---

## ✅ 完成标准

1. 用户可以选择三种认证模式
2. API Key 模式可正常读取公开表格
3. Service Account 模式可读写共享的表格
4. OAuth 测试模式仅限白名单用户
5. 需要写入权限时有清晰提示
6. Service Account 创建说明文档完整易懂
