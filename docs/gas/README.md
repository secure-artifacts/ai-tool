# GAS (Google Apps Script) 部署指南

## 什么是 GAS？

Google Apps Script (GAS) 是 Google 提供的云端脚本平台，可以让您在 Google Sheets 中运行自定义代码，并能部署为 Web App 供外部访问。

**优点：**
- ✅ 无需复杂的 OAuth 配置
- ✅ 无需 API Key 或 Service Account
- ✅ 支持读写操作
- ✅ 免费使用（有配额限制）

**适用场景：**
- 文案查重的文本库功能
- 需要读写 Google Sheets 的场景
- 不想配置复杂认证的用户

---

## 部署步骤

### 第一步：准备表格

1. 打开或创建一个 Google Sheets 表格（这将作为您的文本库）
2. 确保表格有适当的列结构（如：内容、分类、入库时间等）

### 第二步：打开 Apps Script 编辑器

1. 在 Google Sheets 中，点击菜单栏的 **扩展程序**
2. 选择 **Apps Script**
3. 这会打开一个新的标签页，显示脚本编辑器

### 第三步：添加脚本代码

1. 删除编辑器中默认的代码（`function myFunction() {}`）
2. 复制 `TextLibraryService.gs` 文件的全部内容
3. 粘贴到编辑器中
4. 按 **Ctrl+S** (或 **Cmd+S**) 保存

### 第四步：部署为 Web App

1. 点击右上角的 **部署** 按钮
2. 选择 **新建部署**
3. 点击左侧的齿轮图标 ⚙️，选择 **Web 应用**
4. 填写部署信息：
   - **说明**：输入描述，如 "ITEN 文本库服务 v1.0"
   - **执行身份**：选择 **我（您的邮箱地址）**
   - **谁可以访问**：选择 **任何人** ⚠️ 必须选这个！

5. 点击 **部署**
6. 首次部署需要授权：
   - 点击 **授权访问**
   - 选择您的 Google 账号
   - 如果看到"此应用未经 Google 验证"，点击 **高级** → **转至 xxx（不安全）**
   - 点击 **允许**

7. 复制显示的 **Web App URL**（类似 `https://script.google.com/macros/s/AKfycb.../exec`）

### 第五步：配置 ITEN AI 工具包

1. 打开 ITEN AI 工具包
2. 进入 **文案查重** → **文本库设置**
3. 在 **GAS Web App URL** 中粘贴刚才复制的 URL
4. 点击测试连接，确认成功

---

## 更新脚本后重新部署

如果您修改了脚本代码，需要创建新版本：

1. 点击 **部署** → **管理部署**
2. 点击 **编辑** (铅笔图标)
3. 在"版本"下拉框中选择 **新版本**
4. 点击 **部署**

⚠️ **注意**：每次更新代码后都需要创建新版本，否则旧代码仍会运行。

---

## API 使用说明

部署完成后，您的 GAS Web App 支持以下操作：

### GET 请求（读取）

**读取数据**
```
GET {webAppUrl}?action=read&sheetName=分类A
```

**列出所有工作表**
```
GET {webAppUrl}?action=list
```

**获取表格信息**
```
GET {webAppUrl}?action=info
```

### POST 请求（写入）

**追加数据**
```json
POST {webAppUrl}
Content-Type: application/json

{
  "action": "append",
  "sheetName": "分类A",
  "values": [
    ["内容1", "2024-01-01"],
    ["内容2", "2024-01-02"]
  ]
}
```

**创建工作表（分类）**
```json
{
  "action": "createSheet",
  "sheetName": "新分类",
  "headers": ["内容", "入库时间", "来源"]
}
```

**重命名工作表**
```json
{
  "action": "renameSheet",
  "oldName": "旧名称",
  "newName": "新名称"
}
```

**删除工作表**
```json
{
  "action": "deleteSheet",
  "sheetName": "要删除的分类"
}
```

**删除行**
```json
{
  "action": "deleteRows",
  "sheetName": "分类A",
  "rowIndexes": [2, 5, 10]
}
```

---

## 配额限制

Google Apps Script 有以下限制（免费版）：

| 项目 | 限制 |
|------|------|
| 每日执行时间 | 90 分钟 |
| 每次执行时间 | 6 分钟 |
| 每日触发器执行 | 20 次 |
| URL 请求 | 每天 20,000 次 |

对于个人使用的文本库来说，这些限制通常不会成为问题。

---

## 常见问题

### Q: 部署后提示"此应用未经 Google 验证"

这是正常的，因为这是您自己的脚本。点击 **高级** → **转至 xxx（不安全）** 即可继续。

### Q: 无法访问 Web App URL

检查以下几点：
1. 确保"谁可以访问"设置为"任何人"
2. 确保完成了授权步骤
3. 确保使用的是最新部署的 URL

### Q: 请求返回错误

1. 检查请求的 JSON 格式是否正确
2. 查看 Apps Script 的执行日志：**执行** → **执行记录**
3. 确保工作表名称正确

### Q: 如何查看执行日志？

1. 在 Apps Script 编辑器中
2. 点击左侧的 **执行**
3. 可以看到所有请求的执行记录和错误信息

---

## 安全建议

1. **不要公开分享 Web App URL**：只要有 URL 就可以访问您的表格
2. **定期检查表格内容**：确保没有异常数据
3. **设置表格共享权限**：即使 Web App 是公开的，原始表格仍可以保持私有
4. **考虑添加密钥验证**：可以在脚本中添加简单的 API Key 验证

---

## 联系支持

如果您在部署过程中遇到问题，可以：
- 联系技术员获取协助
- 在项目 Issues 中反馈问题
